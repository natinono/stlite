<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Ambient Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.63.1/build/stlite.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script>
      stlite.mount(
        {
          requirements: [
            "streamlit",
            "pandas",
            "matplotlib",
            "japanize-matplotlib",
            "streamlit-autorefresh",
            "git+https://github.com/AmbientDataInc/ambient-python-lib.git", 
            "pyodide-http",
            "requests"
          ],
          entrypoint: "streamlit_app.py",
          files: {
            "streamlit_app.py": `
import streamlit as st
import pandas as pd
import numpy as np
import datetime
import pytz
import ambient
import matplotlib.pyplot as plt
import japanize_matplotlib
from streamlit_autorefresh import st_autorefresh
import pyodide_http

# ブラウザでrequestsを使えるようにパッチを適用
pyodide_http.patch_all()

# Run the autorefresh about every 2000 milliseconds (2 seconds) and stop
# after it's been refreshed 100 times.
count = st_autorefresh(interval=60000, limit=100, key="fizzbuzzcounter")

# 次にデーターをpandasのDataFrameに変換します。
def parse_date(x):
    t = datetime.datetime.strptime(x, '%Y-%m-%dT%H:%M:%S.%fZ')
    return pytz.utc.localize(t).astimezone(pytz.timezone('Asia/Tokyo'))

col1, col2 = st.columns(2)

with col1:
    days=st.number_input('表示する日数',1,30,1,step=1)

with col2:
    if st.button('リロード'):
        st.rerun() # st.experimental_rerun is deprecated

try:
    am = ambient.Ambient(66341,'','91fe241f20d21b0e')
    d = am.read(n=int(days*(24*60)))
    df = pd.DataFrame(d)

    # データが空の場合のエラーハンドリング
    if df.empty:
        st.error("データの取得に失敗しました。CORS制限またはデータが存在しない可能性があります。")
    else:
        # 列を移動
        created = df.pop('created')
        # 2番目の位置に 'img' 列を挿入
        df.insert(0, '日時', created)
        df['日時'] = df['日時'].apply(parse_date)
        df = df.set_index('日時')

        if len(df.columns) == 4:
            df.columns = ['温度','湿度','明るさ','電力']
        elif len(df.columns) == 5:
            df.columns = ['温度','湿度','明るさ','電力','横浜']
        else:
            df.columns = ['温度','湿度','明るさ','電力','横浜','PC起動','電力料金']

        df['不快指数'] = 0.81 * df['温度'] + 0.01 * df['湿度'] * (0.99 * df['温度'] - 14.3 ) + 46.3

        # 電力消費量をワットアワーに変換
        df['電力_'] = df['電力'] * (1/60)
        # 日ごとにグループ化し、それぞれのグループで累積合計を計算
        df['積算電力'] = df.groupby(df.index.date)['電力_'].cumsum()
        # kWhに変換し、価格を乗じて電気使用量を求める
        df['電気料金'] = df['積算電力'] / 1000 * 31

        st.write('### ' + df.index[-1].strftime('%m/%d %H:%M') + '　外気温' + str(df.iloc[-1,:]['横浜']) + '℃　室温' + str(df.iloc[-1,:]['温度']) + '℃　不快指数' + str(int(df.iloc[-1,:]['不快指数'])))

        # フィギュアのサイズとサブプロット間の間隔を指定
        fig, (ax1, ax2) = plt.subplots(2, sharex=True, gridspec_kw={'height_ratios': [2, 1], 'hspace': 0}, figsize=(9, 9))

        # Secondary axes for the plots
        ax1b = ax1.twinx()
        ax2b = ax2.twinx()

        # データのプロット
        df['湿度'].plot(ax=ax1, color='lightblue', label='湿度')
        df['不快指数'].plot(ax=ax1, color='orange', label='不快指数')
        df['横浜'].plot(ax=ax1b, linestyle='--', label='横浜')
        df['温度'].plot(ax=ax1b, color='red', label='室温')
        df['電力'].plot(ax=ax2b, color='orange', label='電力')
        df['明るさ'].plot(ax=ax2, color='green', label='明るさ')
        df['PC起動'].plot(ax=ax2, color='blue', label='PC起動')
        df['電気料金'].plot(ax=ax2, color='red', label='電気料金')

        # 軸ラベルの設定
        ax1.set_ylabel('湿度/不快指数')
        ax1b.set_ylabel('温度')
        ax2.set_ylabel('PC起動/明るさ/電気料金')
        ax2b.set_ylabel('電力')

        # Add grid lines to the right y-axes and x-axes
        ax1.grid(False)  # Turn off grid for left y-axis
        ax1b.grid(True)  # Turn on grid for right y-axis
        ax2.grid(False)  # Turn off grid for left y-axis
        ax2b.grid(True)  # Turn on grid for right y-axis

        # Add grid for x-axis
        ax1.xaxis.grid(True)
        ax2.xaxis.grid(True)

        # 凡例の設定
        lines, labels = ax1.get_legend_handles_labels()
        lines2, labels2 = ax1b.get_legend_handles_labels()
        ax1.legend(lines + lines2, labels + labels2, loc='upper left')

        lines, labels = ax2.get_legend_handles_labels()
        lines2, labels2 = ax2b.get_legend_handles_labels()
        ax2.legend(lines + lines2, labels + labels2, loc='upper left')

        st.pyplot(fig)  # Streamlitでmatplotlibのグラフを表示

        st.image('https://storage.tenki.jp/storage/static-images/forecaster_diary/image/4/48/482/4828/a/20190604091250/large.jpg', width=250)

except Exception as e:
    st.error(f"エラーが発生しました: {e}")
    st.info("ブラウザからのアクセスがブロックされている(CORS)か、ネットワークエラーの可能性があります。")

`
          }
        },
        document.getElementById("root")
      );
    </script>
  </body>
</html>