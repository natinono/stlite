<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æŠ•è³‡å±¥æ­´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import { mount } from "https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js";
        
        // Pythonã‚³ãƒ¼ãƒ‰ã‚’æ–‡å­—åˆ—ã¨ã—ã¦åŸ‹ã‚è¾¼ã¿
        const pythonCode = `
import pandas as pd
import datetime
from datetime import timedelta
import streamlit as st
import plotly.express as px
import plotly.graph_objs as go
from urllib.request import urlopen
import io

JST = datetime.timezone(timedelta(hours=+9), 'JST')

def get_first_date_of_month(dt):
    return dt.replace(day=1)

def get_first_date_of_year(dt):
    return dt.replace(month=1, day=1)

def get_growth(year, df_buy_hyouka):
    if datetime.date.today().year == year:
        end_date = datetime.date.today()
    else:
        end_date = datetime.date(year=year, month=12, day=31)
    this_year_end_value = df_buy_hyouka['è©•ä¾¡é¡'].loc[end_date.strftime('%Y-%m-%d')]
    previous_year_end_value = df_buy_hyouka['è©•ä¾¡é¡'].loc[datetime.date(year=(year-1), month=12, day=31).strftime('%Y-%m-%d')]
    buy_this_year = df_buy_hyouka['è³¼å…¥é¡'].loc[end_date.strftime('%Y-%m-%d')] - df_buy_hyouka['è³¼å…¥é¡'].loc[datetime.date(year=(year-1), month=12, day=31).strftime('%Y-%m-%d')]
    profit = this_year_end_value - buy_this_year - previous_year_end_value
    growth = profit / previous_year_end_value * 100
    this_year_end_value = int(this_year_end_value/10000)
    previous_year_end_value = int(previous_year_end_value/10000)
    buy_this_year = int(buy_this_year/10000)
    profit = int(profit/10000)
    growth = round(growth, 2)
    return this_year_end_value, previous_year_end_value, buy_this_year, profit, growth

@st.cache_data(ttl=3600)
def get_kagaku():
    fund_dict = {
        'å›½å†…æ ªå¼': 'https://toushin-lib.fwg.ne.jp/FdsWeb/FDST030000/csv-file-download?isinCd=JP90C000FXV1&associFundCd=03311182',
        'å…ˆé€²å›½æ ªå¼': 'https://toushin-lib.fwg.ne.jp/FdsWeb/FDST030000/csv-file-download?isinCd=JP90C000ENC5&associFundCd=03319172',
        'å…¨ä¸–ç•Œæ ªå¼': 'https://toushin-lib.fwg.ne.jp/FdsWeb/FDST030000/csv-file-download?isinCd=JP90C000H1T1&associFundCd=0331418A',
        'ç±³å›½æ ªå¼': 'https://toushin-lib.fwg.ne.jp/FdsWeb/FDST030000/csv-file-download?isinCd=JP90C000GKC6&associFundCd=03311187',
        'ãƒãƒ©ãƒ³ã‚¹': 'https://toushin-lib.fwg.ne.jp/FdsWeb/FDST030000/csv-file-download?isinCd=JP90C000EWV6&associFundCd=03312175',
    }
    
    kagaku_df = pd.DataFrame()
    for key, value in fund_dict.items():
        try:
            response = urlopen(value)
            csv_data = response.read()
            
            df = pd.read_csv(io.BytesIO(csv_data), encoding='cp932', skiprows=0)
            df = df.rename(columns={'å¹´æœˆæ—¥': 'æ—¥ä»˜'})
            df['æ—¥ä»˜'] = pd.to_datetime(df['æ—¥ä»˜'], format='%Yå¹´%mæœˆ%dæ—¥')
            df = df.set_index('æ—¥ä»˜')
            df = df.iloc[:, 0:1]
            df.columns = [key]
            kagaku_df = pd.concat([kagaku_df, df], axis=1)
        except Exception as e:
            st.warning(f"{key}ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—: {str(e)}")
    
    kagaku_df = kagaku_df[kagaku_df.index >= '2019-01-01']
    
    try:
        kagaku_df_past = pd.read_csv('kagaku_past.csv', index_col=0, parse_dates=True)
        kagaku_df_past = kagaku_df_past[kagaku_df_past.index < '2019-01-01']
        df_kagaku = pd.concat([kagaku_df_past, kagaku_df])
    except:
        st.info("éŽåŽ»ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚2019å¹´ä»¥é™ã®ã¿è¡¨ç¤ºã—ã¾ã™ã€‚")
        df_kagaku = kagaku_df
    
    return df_kagaku

@st.cache_data
def load_buy_data():
    try:
        buy_xlsx = pd.read_csv('toshin_buy.csv')
        buy_xlsx['å¹´æœˆæ—¥'] = pd.to_datetime(buy_xlsx['å¹´æœˆæ—¥'])
        return buy_xlsx
    except:
        st.error("è³¼å…¥å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«(toshin_buy.csv)ãŒå¿…è¦ã§ã™ã€‚")
        return None

def date_judge(date):
    today = datetime.datetime.now() + datetime.timedelta(hours=9)
    delta_days = (today - date).days
    if delta_days == 0:
        return 'ä»Šæ—¥'
    else:
        return (str(delta_days) + 'æ—¥å‰')

st.title('ðŸ“Š æŠ•è³‡å±¥æ­´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')

kokunai_kongo = 0
senshinkoku_kongo = 0
balance_kongo = 0
zensekai_kongo = 150000
beikoku_kongo = 0

dict_growth = {
    "å›½å†…æ ªå¼": 5,
    "å…ˆé€²å›½æ ªå¼": 5,
    "å…¨ä¸–ç•Œæ ªå¼": 5,
    "ç±³å›½æ ªå¼": 5,
    "ãƒãƒ©ãƒ³ã‚¹": 3,
}

with st.sidebar:
    st.write("### âš™ï¸ è¨­å®š")
    predict_period = st.slider("äºˆæ¸¬æœŸé–“(å¹´)", 0, 30, 0, 1)
    
    st.write("### ðŸ’° ä»Šå¾Œã®æœˆæ¬¡æŠ•è³‡é¡(ä¸‡å††)")
    senshinkoku_kongo = st.slider("å…ˆé€²å›½æ ªå¼", 0, 40, int(senshinkoku_kongo/10000), 1) * 10000
    zensekai_kongo = st.slider("å…¨ä¸–ç•Œæ ªå¼", 0, 40, int(zensekai_kongo/10000), 1) * 10000
    beikoku_kongo = st.slider("ç±³å›½æ ªå¼", 0, 40, int(beikoku_kongo/10000), 1) * 10000
    kokunai_kongo = st.slider("å›½å†…æ ªå¼", 0, 40, int(kokunai_kongo/10000), 1) * 10000
    balance_kongo = st.slider("ãƒãƒ©ãƒ³ã‚¹", 0, 40, int(balance_kongo/10000), 1) * 10000
    
    st.write("### ðŸ“ˆ äºˆæ¸¬å¹´åˆ©(%)")
    dict_growth['å…ˆé€²å›½æ ªå¼'] = st.slider("å…ˆé€²å›½æ ªå¼_å¹´åˆ©", 0, 20, dict_growth['å…ˆé€²å›½æ ªå¼'], 1)
    dict_growth['å…¨ä¸–ç•Œæ ªå¼'] = st.slider("å…¨ä¸–ç•Œæ ªå¼_å¹´åˆ©", 0, 20, dict_growth['å…¨ä¸–ç•Œæ ªå¼'], 1)
    dict_growth['ç±³å›½æ ªå¼'] = st.slider("ç±³å›½æ ªå¼_å¹´åˆ©", 0, 20, dict_growth['ç±³å›½æ ªå¼'], 1)
    dict_growth['å›½å†…æ ªå¼'] = st.slider("å›½å†…æ ªå¼_å¹´åˆ©", 0, 20, dict_growth['å›½å†…æ ªå¼'], 1)
    dict_growth['ãƒãƒ©ãƒ³ã‚¹'] = st.slider("ãƒãƒ©ãƒ³ã‚¹_å¹´åˆ©", 0, 20, dict_growth['ãƒãƒ©ãƒ³ã‚¹'], 1)

try:
    with st.spinner('ðŸ”„ æœ€æ–°ã®åŸºæº–ä¾¡é¡ã‚’å–å¾—ä¸­...'):
        df_kagaku = get_kagaku()
    
    buy_xlsx = load_buy_data()
    
    if buy_xlsx is None:
        st.stop()
    
    str_date = "2017-01-01"
    future_date = str(datetime.date.today() + datetime.timedelta(days=365*predict_period))
    today = datetime.datetime.today()
    
    leatest_date = df_kagaku.index.max()
    
    date_index = pd.date_range("2017-01-04", end=str(datetime.datetime.today()), freq="D")
    df_new = pd.DataFrame(index=date_index)
    df_new = df_new.rename_axis('æ—¥ä»˜')
    df_kagaku = pd.merge_asof(df_new, df_kagaku, on='æ—¥ä»˜', direction='backward')
    df_kagaku = df_kagaku.set_index('æ—¥ä»˜', drop=True)
    
    df_mirai = pd.DataFrame(index=pd.date_range(df_kagaku.index[len(df_kagaku)-1], future_date, freq='MS'), columns=df_kagaku.columns)
    df_kagaku = pd.concat([df_kagaku, df_mirai]).groupby(level=0).last()
    
    for i in range(0, len(df_kagaku)):
        if pd.isna(df_kagaku.iloc[i]['å›½å†…æ ªå¼']) or df_kagaku.iloc[i]['å›½å†…æ ªå¼'] < 0.0:
            for k, v in dict_growth.items():
                if k in df_kagaku.columns:
                    df_kagaku.iloc[i, df_kagaku.columns.get_loc(k)] = df_kagaku.iloc[i-1][k] * (1 + v/100) ** (1/365*((df_kagaku.index[i] - df_kagaku.index[i-1]).days))
    
    df_kagaku_hiritu = df_kagaku.copy()
    df_kagaku_hiritu = df_kagaku_hiritu / df_kagaku_hiritu.loc["2017-12-29"] * 100
    
    df_buy = pd.DataFrame()
    for index, data in buy_xlsx.iterrows():
        if data['å¹´æœˆæ—¥'] not in df_buy.index or data['ã‚¢ã‚»ãƒƒãƒˆ'] not in df_buy.columns:
            df_buy.loc[data['å¹´æœˆæ—¥'], data['ã‚¢ã‚»ãƒƒãƒˆ']] = data['ä¾¡æ ¼']
        else:
            df_buy.loc[data['å¹´æœˆæ—¥'], data['ã‚¢ã‚»ãƒƒãƒˆ']] += data['ä¾¡æ ¼']
    
    df_buy = df_buy.rename_axis('å¹´æœˆæ—¥')
    
    first_row_index = df_buy.reset_index().index[df_buy.index >= today][0] if any(df_buy.index >= today) else len(df_buy)
    
    if first_row_index < len(df_buy):
        if 'å›½å†…æ ªå¼' in df_buy.columns:
            df_buy.iloc[first_row_index:, df_buy.columns.get_loc('å›½å†…æ ªå¼')] = kokunai_kongo
        if 'å…ˆé€²å›½æ ªå¼' in df_buy.columns:
            df_buy.iloc[first_row_index:, df_buy.columns.get_loc('å…ˆé€²å›½æ ªå¼')] = senshinkoku_kongo
        if 'ãƒãƒ©ãƒ³ã‚¹' in df_buy.columns:
            df_buy.iloc[first_row_index:, df_buy.columns.get_loc('ãƒãƒ©ãƒ³ã‚¹')] = balance_kongo
        if 'å…¨ä¸–ç•Œæ ªå¼' in df_buy.columns:
            df_buy.iloc[first_row_index:, df_buy.columns.get_loc('å…¨ä¸–ç•Œæ ªå¼')] = zensekai_kongo
        if 'ç±³å›½æ ªå¼' in df_buy.columns:
            df_buy.iloc[first_row_index:, df_buy.columns.get_loc('ç±³å›½æ ªå¼')] = beikoku_kongo
    
    df_buy = df_buy[(df_buy.index < today) | (df_buy.index.day == 1)]
    
    df_kagaku_hiritu = df_kagaku_hiritu.replace(0, 1.0e-10)
    
    df_kuchisu = (df_buy / df_kagaku_hiritu).fillna(0)
    df_hyouka = df_kagaku_hiritu * df_kuchisu.cumsum()
    
    date_index = df_hyouka.index
    df_new = pd.DataFrame(index=date_index)
    df_new = df_new.rename_axis('æ—¥ä»˜')
    df_buy2 = pd.concat([df_new, df_buy], axis=1, join='outer')
    
    df_buy_hyouka = pd.concat([df_buy2.fillna(0).cumsum().sum(axis=1), df_hyouka.sum(axis=1)], axis=1)
    df_buy_hyouka.columns = ['è³¼å…¥é¡', 'è©•ä¾¡é¡']
    df_buy_hyouka['ç¨Žå¼•å‰åˆ©ç›Š'] = df_buy_hyouka['è©•ä¾¡é¡'] - df_buy_hyouka['è³¼å…¥é¡']
    df_buy_hyouka['ç¨Žå¼•å¾Œåˆ©ç›Š'] = df_buy_hyouka['ç¨Žå¼•å‰åˆ©ç›Š'] * 0.8
    
    st.write("## ðŸ“Š ã‚µãƒžãƒªãƒ¼")
    display_table = pd.DataFrame({
        'æœ€æ–°åŸºæº–ä¾¡é¡': [leatest_date.strftime('%Y/%m/%d') + ' (' + date_judge(leatest_date) + ')'],
        'è©•ä¾¡é¡': ["{:.2f}".format(int(df_buy_hyouka['è©•ä¾¡é¡'][leatest_date]/10000)/100) + 'M'],
        'ç·åˆ©ç›Š': ["{:+.2f}".format(int(df_buy_hyouka['ç¨Žå¼•å‰åˆ©ç›Š'][leatest_date]/10000)/100) + 'M'],
        'å¹´åˆæ¥': ["{:+.2f}".format(int((df_buy_hyouka['è©•ä¾¡é¡'][leatest_date] - df_buy_hyouka['è©•ä¾¡é¡'][get_first_date_of_year(leatest_date)])/10000)/100) + 'M'],
        'æœˆåˆæ¥': ["{:+.2f}".format(int((df_buy_hyouka['è©•ä¾¡é¡'][leatest_date] - df_buy_hyouka['è©•ä¾¡é¡'][get_first_date_of_month(leatest_date)])/10000)/100) + 'M'],
        'å‰æ—¥å·®': ["{:+.2f}".format(int((df_buy_hyouka['è©•ä¾¡é¡'][leatest_date] - df_buy_hyouka['è©•ä¾¡é¡'][leatest_date - datetime.timedelta(days=1)])/10000)/100) + 'M'],
    }).set_index('æœ€æ–°åŸºæº–ä¾¡é¡')
    st.write(display_table)
    
    margin = dict(t=30, b=20, l=20, r=20)
    
    st.write("## ðŸ“ˆ ã‚°ãƒ©ãƒ•")
    display_month = st.slider("è¡¨ç¤ºã™ã‚‹æœŸé–“(æœˆ)", 0, 48, 12, 1)
    str_date2 = datetime.datetime.today() - timedelta(days=display_month*30)
    
    fig4 = px.line(df_buy_hyouka[str_date2:today]['è©•ä¾¡é¡'], title='ç›´è¿‘æœŸé–“ã®è©•ä¾¡é¡æŽ¨ç§»')
    fig4.update_layout(margin=margin, height=400)
    st.plotly_chart(fig4, use_container_width=True)
    
    df_buy_hyouka_filtered = df_buy_hyouka[str_date:future_date].astype(float)
    
    fig3 = px.line(df_buy_hyouka_filtered, title='æç›ŠæŽ¨ç§»')
    fig3.update_layout(margin=margin, height=400)
    st.plotly_chart(fig3, use_container_width=True)
    
    df_hyouka_filtered = df_hyouka[str_date:future_date].astype(float)
    fig2 = px.area(df_hyouka_filtered, title='è©•ä¾¡é¡(ã‚¢ã‚»ãƒƒãƒˆåˆ¥)')
    fig2.update_layout(margin=margin, height=400)
    st.plotly_chart(fig2, use_container_width=True)
    
    df_kagaku_hiritu_filtered = df_kagaku_hiritu[str_date:future_date].astype(float)
    fig1 = px.line(df_kagaku_hiritu_filtered, title='åŸºæº–ä¾¡é¡æŽ¨ç§»(2017å¹´æœ«æ¯”)')
    fig1.update_layout(margin=margin, height=400)
    st.plotly_chart(fig1, use_container_width=True)
    
    st.write("## ðŸ’° æœˆæ¬¡åˆ©ç›Šåˆ†æž")
    monthly_profit = df_buy_hyouka.groupby(pd.Grouper(freq='M'))['ç¨Žå¼•å¾Œåˆ©ç›Š'].agg('last')
    shifted_monthly_profit = monthly_profit.shift(1)
    monthly_profit_diff = monthly_profit - shifted_monthly_profit
    monthly_profit_diff_df = pd.DataFrame(monthly_profit_diff)
    monthly_profit_diff_df['ç¨Žå¼•å¾Œåˆ©ç›Š'] = (monthly_profit_diff_df['ç¨Žå¼•å¾Œåˆ©ç›Š']/10000)
    monthly_profit_diff_df = monthly_profit_diff_df.dropna(subset=['ç¨Žå¼•å¾Œåˆ©ç›Š'])
    monthly_profit_diff_df['ç¨Žå¼•å¾Œåˆ©ç›Š'] = monthly_profit_diff_df['ç¨Žå¼•å¾Œåˆ©ç›Š'].astype(int)
    
    monthly_profit_diff_df["12ã‚«æœˆç§»å‹•å¹³å‡"] = monthly_profit_diff_df["ç¨Žå¼•å¾Œåˆ©ç›Š"].rolling(12).mean()
    monthly_profit_diff_df["24ã‚«æœˆç§»å‹•å¹³å‡"] = monthly_profit_diff_df["ç¨Žå¼•å¾Œåˆ©ç›Š"].rolling(24).mean()
    monthly_profit_diff_df["36ã‚«æœˆç§»å‹•å¹³å‡"] = monthly_profit_diff_df["ç¨Žå¼•å¾Œåˆ©ç›Š"].rolling(36).mean()
    
    trace1 = go.Bar(x=monthly_profit_diff_df.index, y=monthly_profit_diff_df['ç¨Žå¼•å¾Œåˆ©ç›Š'], text=monthly_profit_diff_df['ç¨Žå¼•å¾Œåˆ©ç›Š'], name='æœˆæ¬¡', yaxis='y1', marker_color='#808080')
    trace2 = go.Scatter(x=monthly_profit_diff_df.index, y=monthly_profit_diff_df['12ã‚«æœˆç§»å‹•å¹³å‡'], name='12ã‚«æœˆç§»å‹•å¹³å‡', yaxis='y1', line=dict(color="#00008b"))
    trace3 = go.Scatter(x=monthly_profit_diff_df.index, y=monthly_profit_diff_df['24ã‚«æœˆç§»å‹•å¹³å‡'], name='24ã‚«æœˆç§»å‹•å¹³å‡', yaxis='y1', line=dict(color="#006400"))
    trace4 = go.Scatter(x=monthly_profit_diff_df.index, y=monthly_profit_diff_df['36ã‚«æœˆç§»å‹•å¹³å‡'], name='36ã‚«æœˆç§»å‹•å¹³å‡', yaxis='y1', line=dict(color="#ff0000"))
    
    layout = go.Layout(
        title='æœˆæ¬¡åˆ©ç›Š(ç¨Žå¼•å¾Œ)',
        xaxis=dict(title='æ—¥ä»˜', showgrid=False, dtick='M12'),
        yaxis=dict(title='ä¸‡å††', side='left', dtick=50),
    )
    
    fig6 = go.Figure(data=[trace1, trace2, trace3, trace4], layout=layout)
    st.plotly_chart(fig6, use_container_width=True)
    
    st.write("## ðŸ“… å¹´æ¬¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹")
    year_list = []
    this_year_end_value_list = []
    previous_year_end_value_list = []
    buy_this_year_list = []
    profit_list = []
    growth_list = []
    
    all_country_growth_list = []
    advanced_nations_growth_list = []
    sp500_growth_list = []
    japan_growth_list = []
    balance_growth_list = []
    
    for year in range(2018, (datetime.date.today().year + 1)):
        year_list.append(year)
        this_year_end_value, previous_year_end_value, buy_this_year, profit, growth = get_growth(year, df_buy_hyouka)
        this_year_end_value_list.append(this_year_end_value)
        previous_year_end_value_list.append(previous_year_end_value)
        profit_list.append(profit)
        buy_this_year_list.append(buy_this_year)
        growth_list.append(growth)
        
        if datetime.date.today().year == year:
            end_date = datetime.date.today()
        else:
            end_date = datetime.date(year=year, month=12, day=31)
        
        if 'å…¨ä¸–ç•Œæ ªå¼' in df_kagaku.columns:
            all_country_growth = (df_kagaku['å…¨ä¸–ç•Œæ ªå¼'].loc[end_date.strftime('%Y-%m-%d')] - df_kagaku['å…¨ä¸–ç•Œæ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]) / df_kagaku['å…¨ä¸–ç•Œæ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]
            all_country_growth = round(all_country_growth*100, 2)
            all_country_growth_list.append(all_country_growth)
        else:
            all_country_growth_list.append(0)
        
        if 'å…ˆé€²å›½æ ªå¼' in df_kagaku.columns:
            advanced_nations_growth = (df_kagaku['å…ˆé€²å›½æ ªå¼'].loc[end_date.strftime('%Y-%m-%d')] - df_kagaku['å…ˆé€²å›½æ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]) / df_kagaku['å…ˆé€²å›½æ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]
            advanced_nations_growth = round(advanced_nations_growth*100, 2)
            advanced_nations_growth_list.append(advanced_nations_growth)
        else:
            advanced_nations_growth_list.append(0)
        
        if 'ç±³å›½æ ªå¼' in df_kagaku.columns:
            sp500_growth = (df_kagaku['ç±³å›½æ ªå¼'].loc[end_date.strftime('%Y-%m-%d')] - df_kagaku['ç±³å›½æ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]) / df_kagaku['ç±³å›½æ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]
            sp500_growth = round(sp500_growth*100, 2)
            sp500_growth_list.append(sp500_growth)
        else:
            sp500_growth_list.append(0)
        
        if 'å›½å†…æ ªå¼' in df_kagaku.columns:
            japan_growth = (df_kagaku['å›½å†…æ ªå¼'].loc[end_date.strftime('%Y-%m-%d')] - df_kagaku['å›½å†…æ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]) / df_kagaku['å›½å†…æ ªå¼'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]
            japan_growth = round(japan_growth*100, 2)
            japan_growth_list.append(japan_growth)
        else:
            japan_growth_list.append(0)
        
        if 'ãƒãƒ©ãƒ³ã‚¹' in df_kagaku.columns:
            balance_growth = (df_kagaku['ãƒãƒ©ãƒ³ã‚¹'].loc[end_date.strftime('%Y-%m-%d')] - df_kagaku['ãƒãƒ©ãƒ³ã‚¹'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]) / df_kagaku['ãƒãƒ©ãƒ³ã‚¹'].loc[datetime.date(year=year-1, month=12, day=31).strftime('%Y-%m-%d')]
            balance_growth = round(balance_growth*100, 2)
            balance_growth_list.append(balance_growth)
        else:
            balance_growth_list.append(0)
    
    growth_df = pd.DataFrame(list(zip(year_list, previous_year_end_value_list, this_year_end_value_list, buy_this_year_list, profit_list, growth_list, advanced_nations_growth_list, all_country_growth_list, japan_growth_list, sp500_growth_list, balance_growth_list)), columns=['å¹´', 'å¹´å§‹è©•ä¾¡é¡', 'å¹´æœ«è©•ä¾¡é¡', 'è³¼å…¥é¡', 'åˆ©ç›Š', 'å¹´åˆ©(%)', 'å…ˆé€²å›½å¹´åˆ©', 'å…¨ä¸–ç•Œå¹´åˆ©', 'æ—¥çµŒå¹´åˆ©', 'ç±³å›½å¹´åˆ©', 'ãƒãƒ©ãƒ³ã‚¹å¹´åˆ©'])
    growth_df = growth_df.set_index('å¹´')
    st.dataframe(growth_df, use_container_width=True)

except Exception as e:
    st.error(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
    import traceback
    st.code(traceback.format_exc())
`;
        
        mount(
            {
                requirements: ["plotly", "pandas"],
                entrypoint: "streamlit_app.py",
                files: {
                    "streamlit_app.py": {
                        data: pythonCode
                    },
                    "toshin_buy.csv": {
                        url: "./toshin_buy.csv"
                    },
                    "kagaku_past.csv": {
                        url: "./kagaku_past.csv"
                    }
                }
            },
            document.getElementById("root")
        );
    </script>
</body>
</html>
